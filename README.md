
# Unambiguous detection of SARS-CoV-2 subgenomic mRNAs with single cell RNA sequencing

This repository contains the data and code for our paper:

> Phillip Cohen, Emma J DeGrace, Oded Danziger, Roosheel S Patel, Erika
> A Barrall, Tesia Bobrowski, Thomas Kehrer, Anastasija Cupic, Lisa
> Miorin, Adolfo García-Sastre, Brad R Rosenberg (2023). *Unambiguous
> detection of SARS-CoV-2 subgenomic mRNAs with single cell RNA
> sequencing*. *In revision*

Our pre-print is available here:

> Phillip Cohen, Emma J DeGrace, Oded Danziger, Roosheel S Patel, Erika
> A Barrall, Tesia Bobrowski, Thomas Kehrer, Anastasija Cupic, Lisa
> Miorin, Adolfo García-Sastre, Brad R Rosenberg (2023). *Unambiguous
> detection of SARS-CoV-2 subgenomic mRNAs with single cell RNA
> sequencing*. BioRxiv. Online at
> <https://doi.org/10.1101/2021.11.22.469642>

## Abstract

Single cell RNA sequencing (scRNA-Seq) studies have provided critical insight into the pathogenesis of Severe Acute Respiratory Syndrome CoronaVirus 2 (SARS-CoV-2), the causative agent of COronaVIrus Disease 2019 (COVID-19). scRNA-Seq library preparation methods and data processing workflows are generally designed for the detection and quantification of eukaryotic host mRNAs and not viral RNAs. Here, we compare different scRNA-Seq library preparation methods for their ability to quantify and detect SARS-CoV-2 RNAs with a focus on subgenomic mRNAs (sgmRNAs). We show that, compared to 10X Genomics Chromium Next GEM Single Cell 3′ (10X 3′) libraries or 10X Genomics Chromium Next GEM Single Cell V(D)J (10X 5′) libraries sequenced with standard read configurations, 10X 5′ libraries sequenced with an extended length read 1 (R1) that covers both cell barcode and transcript sequence (termed “10X 5′ with extended R1") increases the number of unambiguous reads spanning leader-sgmRNA junction sites. We further present a data processing workflow, single cell CoronaVirus sequencing (scCoVseq), which quantifies reads unambiguously assigned to viral sgmRNAs or viral genomic RNA (gRNA). We find that combining 10X 5′ with extended R1 library preparation/sequencing and scCoVseq data processing maximizes the number of viral UMIs per cell quantified by scRNA-Seq. Corresponding sgmRNA expression levels are highly correlated with expression in matched bulk RNA-Seq datasets quantified with established tools for SARS-CoV-2 analysis. Using this scRNA-Seq approach, we find that SARS-CoV-2 gene expression is highly correlated across individual infected cells, which suggests that the proportion of viral sgmRNAs remains generally consistent throughout infection. Taken together, these results and corresponding data processing workflow enable robust quantification of coronavirus sgmRNA expression at single cell resolution, and thereby support high resolution studies of viral RNA processes in individual cells.

## Contents

The **analysis** directory contains:

- [:file_folder: paper](/analysis/paper): R Markdown source document for
  manuscript. Includes code to reproduce the figures and tables
  generated by the analysis.
- [:file_folder: data](/analysis/data): Data used in the analysis. Raw
  and processed data can be accessed at GEO
  [GSE189900](https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE189900)

The **R** directory contains: - [:file_folder: R](/R): Two R scripts run
separately from the main paper.RmD analysis file. 1. `functions.R`
contains custom R functions used by `paper.Rmd`. 2.
`Viral_Mapping_by_10X` contains code to quantify the number of reads
that are derived from genome, subgenome, or ambiguous sequences in each
dataset and to plot the results. This plot is presented in manuscript
Figure 2G.

The **bash** directory contains: - [:file_folder: bash](/bash):
Pre-processing scripts used to generate data analyzed in paper.Rmd. This
includes the scripts to run scCoVseq:

1.  `CellRanger_Pipeline` contains all scripts required to run
    CellRanger. This includes:

- `CellRanger_Pipeline/mkref/make_multiple_refs.sh` contains CellRanger
  `mkref` scripts to create combined host-viral references. This script
  takes a fasta and a gtf annotation for a viral genome and combines it
  with a host reference. The syntax for using this code is as follows:
  `./make_multiple_refs.sh PATH_TO_VIRAL_FASTA PATH_TO_VIRAL_GTF` where
  PATH_TO_VIRAL_FASTA is a path to fasta for the viral genome of
  interest and PATH_TO_VIRAL_GTF is a path to a gtf annotation of the
  viral genome. To run this analysis, two annotations are employed:
  `Kim_Single_Chrom` and `NCBI_Single_Chrom`. The corresponding fasta
  and gtf files are stored in
  `analysis/data/raw_data/Combined_References/Modified_CoV2_Reference_Files`.
  This same code can be used to generate either a human or African Green
  Monkey combined viral reference by changing the path requested by the
  `HOST_REF_DIR` string in the script.
- `CellRanger_Pipeline/count` contains CellRanger `count` scripts to
  convert fastqs to count matrices and BAM files.
  - NOTE: 10X 5’ Ext R1 fastqs must be reformatted with the scripts in
    `scCoVseq/Reformat_Ext_R1` before they can be run through CellRanger
    `count`.
  - NOTE: For this paper we subsampled the fastqs to an equivalent
    number of reads/cell. To do this, we first run CellRanger count with
    the NCBI viral reference and perform QC filtering of that output
    based on number of features detected per cell barcode
    (`nFeature_RNA`), number of transcript unique molecular identifiers
    (UMI) per cell barcode (`nCount_RNA`), and percentage of transcript
    UMIs composed of mitochondrial transcript (`percent_mito`) to
    identify likely single, viable cells. Those cell barcodes are output
    to whitelists in `analysis/data/derived_data`, which are used to
    determine the number of cells to expect in each dataset. This
    initial analysis workflow is detailed in
    `analysis/paper/Preparing_CellBC_Whitelists.Rmd`. The fastq files
    are then downsampled to the number of cells in the whitelist \*
    50,000 reads/cell, as detailed in scripts within `Subsample_Fastqs`.

2.  scCoVseq contains all scripts required to run the scCoVseq pipeline.

- `Reformat_Ext_R1/edit_FASTQs.py` reformats fastqs generated from 10X
  5’ Extended R1 to match the format expected by CellRanger. To do this,
  R1 is split into a “pseudo R1 and R2” by collecting sequence prior to
  the template switch oligonucleotide (TSO) adaptor sequence to pseudo
  R1 and collecting sequence following the TSO and converting to reverse
  complement (pseudo R2). This script uses python/3.7.3 and takes as
  input, gzipped R1 fastqs as follows:
  `/edit_FASTQs.py R1_input_fastq=YOUR_R1_FASTQ.GZ` where
  `YOUR_R1_FASTQ.GZ` is the path to the gzipped read 1 fastq file to
  reformat.
  - NOTE: This must be run before running CellRanger count on 10X 5’ Ext
    R1 data.
- `scCoVseq/scCoVseq.sh`takes the BAM output from CellRanger count,
  splits the viral reads into unambiguous genomic and subgenomic reads,
  and then requantifies those reads with host reads with `umi_tools`.
  This script requires `samtools/1.11`, `python/3.7.3`,
  `umi_tools/1.0.0`, `R/3.5.3` with the `readr` and `Matrix` packages.
  The script can be run as follows:
  `./scCoVseq.sh PATH_TO_CELLRANGER_BAM` where `PATH_TO_CELLRANGER_BAM`
  is the path to the position-sorted BAM output from CellRanger.

3.  `Subsample_Fastqs` contains code that subsamples fastqs to a desired
    read depth per cell. To do this it uses barcode whitelists generated
    from running CellRanger on each dataset aligned to a combined host
    viral reference with the viral reference in this case being the NCBI
    reference. The total number of reads are downsampled to 50,000 \*
    the number of expected cells.

4.  `ggsashimi` contains code that is used to make sashimi plots
    (coverage plots with arcs indicating reads spanning a junction in
    the transcript annotation). These plots are presented in manuscript
    Figure 1. This code uses `ggsashimi` which was previously published
    by Garrido-Martín D, et al. PLOS Computational Biology 2018. The
    citation for this package is below: Garrido-Martín D, Palumbo E,
    Guigó R, Breschi A (2018) ggsashimi: Sashimi plot revised for
    browser- and annotation-independent splicing visualization. PLOS
    Computational Biology 14(8): e1006360.
    <https://doi-org.eresources.mssm.edu/10.1371/journal.pcbi.1006360>

## Running scCoVseq

In order to run scCoVseq on this data, follow the steps below:

1.  **Generate transcriptome references** using
    `CellRanger_Pipeline/mkref/make_multiple_refs.sh`. Syntax:
    `./make_multiple_refs.sh PATH_TO_VIRAL_FASTA PATH_TO_VIRAL_GTF`
    where PATH_TO_VIRAL_FASTA is a path to fasta for the viral genome of
    interest and PATH_TO_VIRAL_GTF is a path to a gtf annotation of the
    viral genome. To run this analysis, two annotations are employed:
    Kim_Single_Chrom and NCBI_Single_Chrom. The fasta and gtf files are
    stored in
    `analysis/data/raw_data/Combined_References/Modified_CoV2_Reference_Files`.
    This same code can be used to generate either a human or African
    Green Monkey combined viral reference by changing the path requested
    by the `HOST_REF_DIR` variable in the script.

2.  **Reformat 10X 5’ Extended R1 Data** using
    `bash/scCoVseq/Reformat_Ext_R1/edit_FASTQs.py`
    `/edit_FASTQs.py R1_input_fastq=YOUR_R1_FASTQ.GZ` where
    `YOUR_R1_FASTQ.GZ` is the path to the gzipped read 1 fastq file to
    reformat.

3.  **Reorganize the reformatted 10X 5’ Extended R1 data** into a
    directory such that all reformatted fastqs are within a separate
    directory.

4.  **Run CellRanger count** using
    `bash/CellRanger_Pipeline/count/submit_vero_count.sh` to get initial
    Vero E6 quantification.

5.  **Identify cells in Vero E6 data** using
    `analysis/paper/Preparing_CellBC_Whitelists.Rmd`

6.  **Subsample Vero E6 data** using scripts in `bash/Subsample_Fastqs`.

7.  **Run CellRanger count with subsampled data** using
    `bash/CellRanger_Pipeline/count/submit_vero_count.sh`. At this time,
    also run CellRanger count for A549 data using
    `bash/CellRanger_Pipeline/count/submit_A549_count_ext_R1.sh`

8.  **Run scCoVseq** using `bash/scCoVseq/scCoVseq` like so:
    `./scCoVseq.sh PATH_TO_CELLRANGER_BAM` where
    `PATH_TO_CELLRANGER_BAM` is the path to the position-sorted BAM
    output by CellRanger

### How to cite

Please cite the paper as:

> Phillip Cohen, Emma J DeGrace, Oded Danziger, Roosheel S Patel, Erika
> A Barrall, Tesia Bobrowski, Thomas Kehrer, Anastasija Cupic, Lisa
> Miorin, Adolfo García-Sastre, Brad R Rosenberg (2023). *Unambiguous
> detection of SARS-CoV-2 subgenomic mRNAs with single cell RNA
> sequencing*. *In revision*

### Licenses

**Code :** MIT License, Copyright (c) 2023 Phillip Cohen, Brad R
Rosenberg

**Data :** [CC-0](http://creativecommons.org/publicdomain/zero/1.0/)
attribution requested in reuse

The organization of this repository was adapted from the `rrtools`
research compendium structure:

> Marwick, B. (2017). Computational reproducibility in archaeological
> research: Basic principles and a case study of their
> implementation.*Journal of Archaeological Method and Theory*, 24(2),
> 424-450.<https://doi.org/10.1007/s10816-015-9272-9>
